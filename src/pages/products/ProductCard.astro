---
import AddToCartButton from "../../components/ui/AddToCartButton";

type Props = {
  product: {
    id: string;
    slug: string;
    code: string;
    brand: string;
    name: string;
    price: number;
    compareAtPrice?: number;
    stock: number;
    imagePath: string;
    lampType?: "compatible" | "original";
    includesIgv?: boolean;
  };
};

const { product } = Astro.props;

const typeLabel = product.lampType === "original" ? "Original" : "Compatible";
const typeStyles =
  product.lampType === "original"
    ? "bg-white/10 text-foreground border-white/10"
    : "bg-primary/15 text-primary border-primary/20";

const stockLabel = product.stock > 0 ? "En stock" : "Agotado";
const stockStyles =
  product.stock > 0
    ? "bg-success/15 text-success border-success/20"
    : "bg-white/10 text-muted border-white/10";

const igvLabel = product.includesIgv === false ? "Sin IGV" : "Incluye IGV";

const showConsultPrice = product.price <= 0;

const hasDiscount =
  !showConsultPrice &&
  typeof product.compareAtPrice === "number" &&
  product.compareAtPrice > product.price;

const discountPct = hasDiscount
  ? Math.round(((product.compareAtPrice - product.price) / product.compareAtPrice) * 100)
  : 0;
---

<article class="group h-full rounded-2xl border border-white/10 bg-surface/50 hover:bg-surface/70 transition overflow-hidden">
  <a href={`/products/${product.slug}`} class="block h-full">
    <div class="p-4 sm:p-5">
      <div class="relative rounded-2xl bg-white overflow-hidden">
        <img
          src={product.imagePath}
          alt={product.name}
          class="w-full h-44 sm:h-56 lg:h-60 object-contain transition group-hover:scale-[1.02]"
          loading="lazy"
        />
      </div>

      <div class="mt-4 flex flex-col min-h-[170px] sm:min-h-[190px]">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 min-w-0">
            <span class="shrink-0 text-[10px] sm:text-[11px] px-2.5 py-1 rounded-full border border-white/10 bg-background/40 text-muted">
              {product.brand}
            </span>
            <span class={`shrink-0 text-[10px] sm:text-[11px] px-2.5 py-1 rounded-full border ${typeStyles}`}>
              {typeLabel}
            </span>
          </div>

          <span class={`shrink-0 text-[10px] sm:text-[11px] px-2.5 py-1 rounded-full border ${stockStyles}`}>
            {stockLabel}
          </span>
        </div>

        <h3 class="mt-3 text-foreground font-extrabold text-base sm:text-lg leading-snug break-words">
          {product.code}
        </h3>

        <p class="mt-1 text-xs sm:text-sm text-muted leading-5">
          Para <span class="text-foreground/90 font-semibold">{product.brand}</span>
          <span class="mx-2 text-white/10">|</span>
          <span class="text-muted">SKU: {product.code}</span>
        </p>

        <div class="mt-3 flex items-end justify-between gap-3">
          <div class="min-w-0">
            {showConsultPrice ? (
              <p class="text-foreground font-extrabold text-lg sm:text-xl leading-tight">
                Precio por consultar
              </p>
            ) : (
              <div class="flex items-end gap-2 flex-wrap">
                <p class="text-foreground font-extrabold text-lg sm:text-xl leading-tight">
                  $ {product.price}
                </p>

                {hasDiscount && (
                  <>
                    <p class="text-sm text-muted line-through">
                      $ {product.compareAtPrice}
                    </p>
                    <span class="text-[11px] px-2 py-1 rounded-full border border-primary/20 bg-primary/15 text-primary font-semibold">
                      -{discountPct}%
                    </span>
                  </>
                )}
              </div>
            )}
          </div>

          <span class="text-[11px] sm:text-xs text-muted whitespace-nowrap">
            {igvLabel}
          </span>
        </div>
      </div>

      <div class="mt-4">
        {product.stock > 0 ? (
          <AddToCartButton client:load product={product} />
        ) : (
          <button
            type="button"
            class="w-full rounded-xl border border-white/10 bg-white/5 text-muted font-semibold py-3 cursor-not-allowed"
            disabled
          >
            Agotado
          </button>
        )}
      </div>
    </div>
  </a>
</article>
